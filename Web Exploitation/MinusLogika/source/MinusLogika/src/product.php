<?php
require 'utils.php';
if (!isset($_SESSION["username"])) { header("Location: index.php"); exit; }

$db = get_db();
$username = $_SESSION["username"];
$message = "";

$products = [
    "ak-47"   => ["name" => "AK-47", "price" => 1600, "img" => "ak-47.png"],
    "desert-eagle" => ["name" => "Desert-Eagle", "price" => 400, "img" => "dessert-eagle.jpg"],
    "flag"   => ["name" => "FLAG", "price" => 999999, "img" => "flag.jpg", ]
];

$stmt = $db->prepare("SELECT money FROM users WHERE username = :u");
$stmt->bindValue(":u", $username, SQLITE3_TEXT);
$user = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
$money = $user["money"]; 
$notes = "Delivered";

if ($_SERVER["REQUEST_METHOD"] === "POST" && isset($_POST["product"])) {
  if (array_key_exists($_POST["product"], $products)){
    $prod = $_POST["product"];
    $price = $_POST["price"];
    if ($prod === "flag" && $price != $products[$prod]["price"]){
      $message = "Hacking Alert";
    }else{
      if ($money >= $price) {
          $db->exec("BEGIN");
          $stmt = $db->prepare("UPDATE users SET money = money - :p WHERE username = :u");
          $stmt->bindValue(":p", $price, SQLITE3_INTEGER);
          $stmt->bindValue(":u", $username, SQLITE3_TEXT);
          $stmt->execute();
          if ($prod === "flag"){
            $notes = "Order Testing - UCS{aku_dapet_banyak_duit_yey_hasil_ngeloot}";
          }
          $stmt = $db->prepare("INSERT INTO orders (id, user, product, notes, timestamp) VALUES (:i, :u, :pr, :nt, :t)");
          $stmt->bindValue(":i", time(), SQLITE3_TEXT);
          $stmt->bindValue(":u", $username, SQLITE3_TEXT);
          $stmt->bindValue(":pr", $products[$prod]["name"], SQLITE3_TEXT);
          $stmt->bindValue(":nt", $notes , SQLITE3_TEXT);
          $stmt->bindValue(":t", time(), SQLITE3_INTEGER);
          $stmt->execute();
          $db->exec("COMMIT");

          header("Location: order_history.php");
          exit;
      } else {
          $message = "Not enough money!";
      }
    }   
  } else {
      $message = "Hacking Alert";
    } 
}

?>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="product.php">CTF Shop</a>
    <div class="navbar-nav">
      <a class="nav-link" href="product.php">Home</a>
      <a class="nav-link" href="order_history.php">Order History</a>
      <a class="nav-link" href="logout.php">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h3>Welcome <?= htmlspecialchars($username) ?>!</h3>
  <p>Your Money: <span class="badge bg-success"><?= $money ?></span></p>

  <?php if ($message): ?>
    <div class="alert alert-warning"><?= $message ?></div>
  <?php endif; ?>

  <div class="row">
    <?php foreach ($products as $key => $prod): ?>
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-body">
            <form method="POST">
              <img src="/assets/<?= $prod["img"] ?>" alt="<?= $prod["name"] ?>" class="d-block mx-auto" style="height: 100px; object-fit: cover;">
              <h5 class="card-title"><?= $prod["name"] ?></h5>
              <p class="card-text">Price: <?= $prod["price"] ?></p>    
              <input type="hidden" name="price" value="<?= $prod["price"] ?>">
                <button type="submit" name="product" value="<?= $key ?>" class="btn btn-primary w-100">Buy</button>
            </form>
          </div>
        </div>
      </div>
    <?php endforeach; ?>
  </div>
</div>

</body>
</html>

