<?php
require 'utils.php';
$db = get_db();
$message = "";

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $action = $_POST["action"];
    $username = trim($_POST["username"]);
    $password = trim($_POST["password"]);

    if ($action === "register") {        
        if (strlen($password) < 8) {
            $message = "Password harus minimal 8 karakter!";
        } elseif (!preg_match('/[A-Z]/', $password)) {
            $message = "Password harus mengandung huruf besar!";
        } elseif (!preg_match('/[a-z]/', $password)) {
            $message = "Password harus mengandung huruf kecil!";
        } elseif (!preg_match('/[0-9]/', $password)) {
            $message = "Password harus mengandung angka!";
        } elseif (!preg_match('/[\W_]/', $password)) {
            $message = "Password harus mengandung simbol!";
        } else {            
            $stmt = $db->prepare("SELECT * FROM users WHERE username = :u");
            $stmt->bindValue(":u", $username, SQLITE3_TEXT);
            $res = $stmt->execute()->fetchArray();
            if ($res) {
                $message = "User already exists!";
            } else {
                $stmt = $db->prepare("INSERT INTO users (username, password, money) VALUES (:u, :p, 2000)");
                $stmt->bindValue(":u", $username, SQLITE3_TEXT);
                $stmt->bindValue(":p", password_hash($password, PASSWORD_DEFAULT), SQLITE3_TEXT);
                $stmt->execute();
                $message = "Registration successful, please login.";
            }
        }    
    } elseif ($action === "login") {
        $stmt = $db->prepare("SELECT * FROM users WHERE username = :u");
        $stmt->bindValue(":u", $username, SQLITE3_TEXT);
        $res = $stmt->execute()->fetchArray(SQLITE3_ASSOC);

        if ($res && password_verify($password, $res["password"])) {
            $_SESSION["username"] = $username;
            header("Location: product.php");
            exit;
        } else {
            $message = "Invalid username or password!";
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Login/Register</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h2 class="text-center mb-4">Login/Register</h2>
          <?php if ($message): ?>            
            <?php if ($message === "Registration successful, please login."): ?>
              <div class="alert alert-success"><?= $message ?></div>
            <?php else: ?>
              <div class="alert alert-danger"><?= $message ?></div>
            <?php endif; ?>              
          <?php endif; ?>
          <form method="POST">
            <div class="mb-3">
              <input type="text" class="form-control" name="username" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" name="password" placeholder="Password" required>
            </div>
            <div class="d-flex justify-content-between">
              <button name="action" value="login" class="btn btn-primary">Login</button>
              <button name="action" value="register" class="btn btn-secondary">Register</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
