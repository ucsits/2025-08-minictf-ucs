<?php
require 'utils.php';
if (!isset($_SESSION["username"])) { header("Location: index.php"); exit; }

$db = get_db();
$username = $_SESSION["username"];
$search = $_GET["search"] ?? "";

function display_order($o) {
    return "[{$o['id']}] {$o['product']} - " . date("Y-m-d H:i:s", $o["timestamp"]);
}
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Order History</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="product.php">CTF Shop</a>
    <div class="navbar-nav">
      <a class="nav-link" href="product.php">Home</a>
      <a class="nav-link active" href="order_history.php">Order History</a>
      <a class="nav-link" href="logout.php">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h3>Order History (Search by Product Name)</h3>

  <form method="GET" class="mb-3">
    <div class="input-group">
      <input type="text" class="form-control" name="search" placeholder="Search by name.." value="<?= htmlspecialchars($search) ?>">
      <button class="btn btn-outline-primary" type="submit">Search</button>
    </div>
  </form>

  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th scope="col">Product ID</th>
        <th scope="col">Item Name</th>
        <th scope="col">Notes</th>
        <th scope="col">Order Date</th>
      </tr>
    </thead>
    <tbody>
    <?php
        $query = "SELECT * FROM orders WHERE user = :u";
        if ($search) $query .= " AND product LIKE :s";

        $stmt = $db->prepare($query);
        $stmt->bindValue(":u", $username, SQLITE3_TEXT);
        if ($search) $stmt->bindValue(":s", "%$search%", SQLITE3_TEXT);

        $res = $stmt->execute();
        $found = false;
        while ($row = $res->fetchArray(SQLITE3_ASSOC)) {
            echo "<tr>
                    <td>{$row['id']}</td>
                    <td>{$row['product']}</td>
                    <td>{$row['notes']}</td>
                    <td>" . date("Y-m-d H:i:s", $row['timestamp']) . "</td>
                  </tr>";
            $found = true;
        }
        if (!$found) {
            echo "<tr><td colspan='3' class='text-center text-muted'>No orders yet</td></tr>";
        }
    ?>
    </tbody>
  </table>
</div>


</body>
</html>
  